<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

	<meta charset="utf-8">

	<script>var url = document.URL;</script>


	<link rel="stylesheet" type="text/css" href="http://localhost/jsdirls-sett/hsa.css"/>

	<script src="http://localhost/jsdirls-sett/jquery.js"></script>
  	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>

    <!-- <script src="http://localhost/jsdirlisting/audiojs/audio.min.js"></script> -->
	<script src="http://localhost/jsdirlisting/audiojs/audio.min.js"></script> 

	<link href="http://vjs.zencdn.net/4.0/video-js.css" rel="stylesheet">
	<script src="http://vjs.zencdn.net/4.0/video.js"></script>

    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.1/themes/base/jquery-ui.css"/>

	<script type="text/javascript" src="jquery.gdocsviewer.min.js"></script>

	<script src="jquery.liveFilter.js"></script>


</head>
<body>


<div class="button">FANCY</div>
<script>

	var collapseAllOnDirectLink = true;
	var searchable = true;


	var IMG = 0;
	var TXT = 1;
	var DIR = 2;
	var AUD = 3;
	var VID = 4;
	var DOC = 5;

	var configfiles = [".jsdirls-collapsed", "X.jsdirls-expanded", ".jsdirls-nonexpandable", "x.jsdirls-expandable"];

	var default_expanded = null;
	var default_expandable = null;
	
	var listing;
	var videocount = 0;
	var dynLoadedFiles = "";

	var audio = [];

	$('.button').click(function () {
		if(expanded) {
			resetListing();
		} else { 
			processListing();
		}
	});

    $( document ).ready(function() {
    	checkURL();
    	loadRules();
	});


/*function initAudio() {
     audiojs.events.ready(function() {
     	//if(as == undefined) {
	    	audio = audiojs.createAll();
		//}
  	});
 }*/

	window.onload = function() {
		console.log("================== ONLOAD =====================");
		if(directLink && directLinkFound) {
			scrollToDiv(document.getElementById(directLinkFile));
    	}
    	if(searchable) {
    		initSearch();
    	}
	}

	function initSearch() {
		$('#search-list').liveFilter('#search-input', 'div', {
		  filterChildSelector: 'a:first()',  
		  	filter: function(el, val){
		             return $(el).text().toUpperCase().indexOf(val.toUpperCase()) >= 0;
		      },
		});
	}

	function scrollToDiv(elem){
		var scroll = elem.offsetTop;
		$('body,html').animate({ scrollTop: scroll }, 400);
	}

//================================================================================================

	var listAbility; 
	var listState;
	var ruleCount = 0;
	var rulesLoaded = false;
	var url;
	var directLink = false;
	var directLinkFile;
	var directLinkFound = false;

	function checkURL() {
		url = document.URL;
		var i = url.lastIndexOf("/")+1;
		if(url.charAt(i) == '#') {
			if(url.length > (i+1)) {
				directLink = true;
				directLinkFile = url.substring(i+1, url.length);
				console.log(directLinkFile);
			}
			url = url.substring(0, i);
		} 
	}


	function loadRules() {
		jQuery.get(url +configfiles[0], getRule0).fail(getRule0);
		jQuery.get(url +configfiles[2], getRule2).fail(getRule2);
		jQuery.get(url +configfiles[1], getRule1).fail(getRule1);
		jQuery.get(url +configfiles[3], getRule3).fail(getRule3);
	}


	function getRule0(data) {
		if(typeof data == "string") {
			setRules(0, parseRules(data));
		} else {
			setRules(0, null)
		}
	 }

	function getRule1(data) {
		if(typeof data == "string") {
			setRules(1, parseRules(data));
		} else {
			setRules(1, null)
		}
	}	 
	function getRule2(data) {
		if(typeof data == "string") {
			setRules(2, parseRules(data));
		} else {
			setRules(2, null)
		}
	}
	function getRule3(data) {
		if(typeof data == "string") {
			setRules(3, parseRules(data));
		} else {
			setRules(3, null)
		}
	}


	function parseRules(data) {
		var conf = data.replace(/^#.*(\n|$)/mg, '');	//remove comments
			conf = conf.replace(/^(\r\n|\n|\r)/mg," ");	//remove newlines
			//conf = conf.replace(/ /g,'');				//remove whitespace
		var lines = conf.split('\n');

		return lines;
	}


	function setRules(num, data) {
		ruleCount++;
		if(num == 0 && data != null) {
			default_expanded = true;
			listState = data;
		} else if (num == 1 && data != null) {
			if(default_expanded != true) {
				default_expanded = false;
				listState = data;
			}
		} else if(num == 2 && data != null) {
			default_expandable = true;
			listAbility = data;
		} else if (num == 3 && data != null) {
			if(default_expandable != true) {
				default_expandable = false;
				listAbility = data;
			}
		}

		if(!rulesLoaded) {
			if(default_expanded != null && default_expandable != null) {
				rulesLoaded = true;
				rulesFinished();
			} else if (ruleCount == 4) {
				default_expanded = (default_expanded == null) ? true : default_expanded;
				default_expandable = (default_expandable == null) ? true : default_expandable;
				//listAbility = null;
				//listState = null;
				rulesLoaded = true;
				rulesFinished();
			}
		}
	}


	function rulesFinished() {
		console.log("DEF_ABILITY: " +default_expandable);
		console.log("DEF_STATE: " +default_expanded);

		console.log("LIST_ABI: " +listAbility );
		console.log("LIST_STA: " +listState );

		processListing();
	}




	function checkRuleState($link) {
		if(directLink) {
			if(!directLinkFound) {
				if(directLinkFile == decodeURIComponent($link)) {
					directLinkFound = true;
					return true;
				} else {
					if(collapseAllOnDirectLink) {
						return false;
					}
				}
			} else {
				if(collapseAllOnDirectLink) {
					return false;
				}
			}
		} 			


		var state = jQuery.inArray(decodeURIComponent($link), listState);
		if(default_expanded == true) {
			if(state == -1)	return true;
			else return false;
		} else {
			if(state == -1)	return false;
			else return true;
		}
		
	}

	function checkRuleAbility($link) {
		var ability = jQuery.inArray(decodeURIComponent($link), listAbility);
		if(default_expandable == true) {
			if(ability == -1)	return true;
			else return false;
		} else {
			if(ability == -1)	return false;
			else return true;
		}
	}


//================================================================================================

	function resetListing() {
		$('pre').html(listing)
		//$('pre').attr('style', 'white-space: pre;');
		expanded = false;
	}


    function processListing() {
    	listing = $('pre').html();
		//$('pre').attr('style', 'white-space: normal;');
		//$('pre').attr('id', 'sortable');
	 	$('pre').attr('id', 'search-list');

	 	if(searchable) {
	 		$('pre').parent().prepend('<input class="search" id="search-input" type="text" value="">');
	 	}

		//insert navigation-div
		$('pre').prepend('<div class="navigation"></div><hr class="top" / >');


		//wrap all textnodes inside pre
		$('pre').contents().filter(function() {
		  return this.nodeType == 3;
		})
		  .wrap('<div class="metainfo"></div>');

		//trim and remove "empty" text-nodes
		$('pre div.metainfo').each(function() {
			//$(this).html($(this).html().trim());
			if($(this).html() === ' ') {
				$(this).remove();
			}
		});

		//remove sorting-table-headers
		$('pre a:lt(4)').each(function() {
   			$(this).remove();
		});

		//wrap listentries (icon, a and metatext)
		$('img + a + div.metainfo').each(function() {
			var $u = $(this).prev().andSelf().prev();
//			$u.wrapAll('<div class="listentry" id="draggable" ></div>');
			$u.wrapAll('<div class="listentry"></div>');
			$(this).prev().append($(this));
		});

	 	expanded = true;

	 	handleContent();

	}



    function handleContent() {

		//determine file-type and handle it
		$('pre div.listentry').each(function() {

			$linknode = $(this).children('a');
			$link = $linknode.attr('href');

			$(this).attr("id", $link);

			var re_image = /.jpg|.gif|.png|.jpeg/;
			var re_text = /.txt|.html|.css/;
			var re_folder = '/';
			var re_audio = /.mp3|.wav|.aif|.ogg/;
			var re_video = /.mp4|.ogv|.webm|.avi/;
			var re_doc = /.pdf/;

			var type = null;

			if($link.match(re_image)) {
				type = IMG;
			} 
			else if($link.match(re_text)) {
				type = TXT;			
			}
			else if($link.match(re_folder)) {
				type = DIR;			
			}
			else if($link.match(re_audio)) {
				type = AUD;			
			}
			else if($link.match(re_video)) {
				type = VID;			
			}
			else if($link.match(re_doc)) {
				type = DOC;			
			}
			if(type == DIR) {
				handleTypeFolder($linknode, $link);
			} else if(type != null) {
				var state = checkRuleState($link);
				var ability = checkRuleAbility($link);

				if(state) state = "expanded";
				else state = "collapsed";

				if(state != null && ability != false ) {

	 				registerClickHandler($linknode, $link, state, type);

	 				if(state == "expanded") {
	 					handleTypes($linknode, $link, state, type);
					}
				}
			}
		});


	/*
	$('pre #draggable').each(function() {
		   		    //$(this).resizable( {
		   		    	//alsoResize: "pre #draggable"
		   		    //});
		   		    //$(this).resizable();
		   		    $(this).draggable(); 		    
	});	
	*/

	
	//$('pre div a img').resizable();
 	$( "#search-list" ).sortable({ axis: "y", cancel: "#search-list .navigation"});
	$( "#search-list" ).disableSelection();

	$('a.embed').gdocsViewer({ width: 400, height: 500 });

	//document.location.href = '#' +directLinkFile;
	 //expanded = true;

    } //end handleContent

    function handleTypes($linknode, $link, state, type) {
		if(type == IMG) {
			handleTypeImage($linknode, $link, state);
		} 
		else if(type == TXT) {
			handleTypeText($linknode, $link, state);			
		}
		else if(type == AUD) {
			handleTypeAudio($linknode, $link, state);			
		}
		else if(type == VID) {
			handleTypeVideo($linknode, $link, state);			
		}
		else if(type == DOC) {
			//handleTypeDocument($linknode, $link, state);			
		}
		$linknode.parent().attr("alt", "loaded");
    }

	function registerClickHandler($linknode, $link, state, type) {
	  	$linknode.parent().attr("class", ("listentry " +state));
	  	$linknode.parent().children('img:first').click(function(){toggleCollapse($linknode, $link, state, type)});
	  	$linknode.parent().children('div.metainfo').click(function(){toggleCollapse($linknode, $link, state, type)});
    }


    function toggleCollapse($linknode, $link, state, type) {
    	$elem = $linknode.parent();
    	if($elem.attr("class") ==  "listentry collapsed") {
    		expandElem($linknode, $link, state, type);
    	} else if ($elem.attr("class") ==  "listentry expanded") {
    		collapseElem($linknode, $link, state, type);
    	}
    }

 	function collapseElem($linknode, $link, state, type) {
    	$elem.attr("class", "listentry collapsed");

 		if(type == AUD) {
 			handleTypeAudio($linknode, $link, false);
 		} else if(type == VID) {
 			handleTypeVideo($linknode, $link, false);
 		}
    }

    function expandElem($linknode, $link, state, type) {
    	$elem = $linknode.parent();
    	$elem.attr("class", "listentry expanded");
    	if($elem.attr("alt") != "loaded") {
	    	handleTypes($linknode, $link, state, type);
	    }
    }



	function handleTypeImage($linknode, $link, state) {
	  $linknode.parent().append('<a href="' +$link +'"><img src="' +$link +'" class="image" /></a>');
	}

	function handleTypeText($linknode, $link, state) {
		jQuery.get($link, function(data) {
				  var $text = data;
				  $node = $('<div class="text"></div>');
				  $node.text($text);
				  $linknode.parent().append($node);
		});	
	}

	function handleTypeFolder($linknode, $link) {
	  //removeIcon($linknode);
	  removeMetainfo($linknode);
	  $linknode.html($link);
	  $('pre div.navigation').append($linknode.parent());
	}


	function handleTypeAudio($linknode, $link, state) {
	  //dynLoadJs("audiojs/audio.js", "js", initAudio);
	  	if(state) {
	  		$node = $('<audio preload="auto"><source src="./' +$link +'"  /></audio>');
		  	$linknode.parent().append($node);
		  	var au = audiojs.create($node, {});
		  	audio.push(au[0]);

		} else {
 			for (var i in audio) {
 				var s = audio[i].source.src;
 				s = s.substring(s.lastIndexOf("/")+1 ,s.length);
 				if(s == $link) {
 					audio[i].pause();
 					break;
 				}
 			}
 		}
	}
	
	function handleTypeVideo($linknode, $link, state) {
		if(state) {
		  	$linknode.parent().removeAttr("id");
	  		$node = $('<video id="dirlistvideo_' +videocount +'" class="video-js vjs-default-skin" width="640" height="264">\
	  						   <source src="' +$link +'" type="video/mp4"></video>');
	  		$linknode.parent().append($node);
	  		_V_(("dirlistvideo_" +videocount), {"controls": true, "autoplay": false, "preload": "auto"}, function(){});
	  		videocount++;
	  	} else {
		 	for (var i = videocount-1; i >= 0; i--) {
				var v = _V_(("dirlistvideo_" +i));//  .pause();	 
				var s = v.currentSrc();
				s = s.substring(s.lastIndexOf("/")+1 ,s.length);
				if(s == $link) {
					v.pause();
				}
			}
		}
	}
	
	function handleTypeDocument($linknode, $link, state) {
	  //removeIcon($linknode);
	  //removeMetainfo($linknode);
//		  $linknode.parent().removeAttr("id");
//		  $linknode.replaceWith($('<video id="dirlistvideo_' +videocount +'" class="video-js vjs-default-skin" width="640" height="264">\
//		  						   <source src="' +$link +'" type="video/mp4"></video>'));

//		  $linknode.replaceWith($('<a href="http://www.hs-augsburg.de/~bs/IA4/weeklys/Weekly02.pdf" class="embed">...</div>'));

	  $node = $('<a href="http://www.hs-augsburg.de/~bs/IA4/weeklys/Weekly02.pdf" class="embed">...</div>');
	  $linknode.parent().append($node);
	}

	function removeMetainfo($siblingnode) {
		  $siblingnode.next().remove();
	}

	function removeIcon($siblingnode) {
		  $siblingnode.prev().remove();
	}
	
	function dynLoadJs(filename, filetype, callback) {
		$.getScript(filename)
			.done(function(script, textStatus) {
				if(callback != undefined) {
					callback();
			  	}
			})
			.fail(function(jqxhr, settings, exception) {
		  $( "div.log" ).text( "Triggered ajaxError handler." );
		});
	}

	function dynLoadJsCss(filename, filetype) {
		if (dynLoadedFiles.indexOf("["+filename+"]") == -1){
			if (filetype == "js") {
				var fileref=document.createElement('script');
				fileref.setAttribute("type","text/javascript");
				fileref.setAttribute("src", filename);
			}
			else if (filetype == "css") {
				var fileref=document.createElement("link");
				fileref.setAttribute("rel", "stylesheet");
				fileref.setAttribute("type", "text/css");
				fileref.setAttribute("href", filename);
			}
			if (typeof fileref != "undefined") {
				document.getElementsByTagName("head")[0].appendChild(fileref);
			}
			dynLoadedFiles+="["+filename+"]";
		} else {
	  		//alert("file already added!");
	  	} 	
	}




</script>
    
<font>
<table class="tottom">
<tr width="100%">
<td height="100" align="left" valign="bottom">
	<img src="http://www.hs-augsburg.de/~bs/.globals/img/header_ia4_bs.png" border="0">
</td>
<td width="100%" height="115" align="right" valign="bottom">
	<a href="http://www.hs-augsburg.de/~bs/"><img src="http://www.hs-augsburg.de/~bs/.globals/img/header_ia4.png"border="0"></a>
</td>
</tr>
<tr height="10">
<td colspan="2">
	<hr class="main" / >
</td></tr>
</table>
